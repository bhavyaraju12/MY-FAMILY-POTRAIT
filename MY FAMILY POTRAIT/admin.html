<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Doctors</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        button {
            position: relative;
            background-color: rgb(230, 34, 77);
            border-radius: 5px;
            box-shadow: rgb(121, 18, 55) 0px 4px 0px 0px;
            background-repeat: no-repeat;
            margin-top: 10px;
            cursor: pointer;
            box-sizing: border-box;
            width: 154px;
            height: 40px;
            color: #fff;
            border: none;
            font-size: 20px;
            transition: all 0.3s ease-in-out;
            z-index: 1;
            overflow: hidden;
            margin-left: 950px;
        }

        button::before {
            content: "";
            background-color: rgb(248, 50, 93);
            width: 0;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            transition: width 700ms ease-in-out;
            display: inline-block;
        }

        button:hover::before {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="flex">
        <!-- Side Panel -->
        <div class="w-1/4 bg-gray-800 text-white h-screen p-4">
            <h1 class="text-2xl font-bold mb-4 text-center">Admin Dashboard</h1>
            <nav>
                <ul class="space-y-4">
                    <li><a href="#" data-target="doctorList" class="block py-2 px-4 rounded hover:bg-gray-700">Doctor List</a></li>
                    <li><a href="#" data-target="approvedDoctors" class="block py-2 px-4 rounded hover:bg-gray-700">Approved Doctors</a></li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="w-3/4 p-6">
            <section id="doctorList" class="hidden">
                <h2 class="text-xl font-semibold border-b-2 border-gray-300 pb-2 mb-4">Doctor List</h2>
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="w-full bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">License Number</th>
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">Specialty</th>
                            <th class="py-3 px-6 text-left">Email</th>
                            <th class="py-3 px-6 text-left">Approval</th>
                        </tr>
                    </thead>
                    <tbody id="doctorTableBody" class="text-gray-700">
                        <!-- Doctor records will be populated here -->
                    </tbody>
                </table>
                <button type="submit" id="approveButton">Approve</button>
            </section>

            <!-- Approved Doctors Section -->
            <section id="approvedDoctors" class="hidden">
                <h2 class="text-xl font-semibold border-b-2 border-gray-300 pb-2 mb-4">Approved Doctors</h2>
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="w-full bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">License Number</th>
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">Specialty</th>
                            <th class="py-3 px-6 text-left">Email</th>
                        </tr>
                    </thead>
                    <tbody id="approvedDoctorTableBody" class="text-gray-700">
                        <!-- Approved doctor records will be populated here -->
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <script>
        const key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ia3BsbWZwZXJqdGVndWdjd3p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgxNzQzMDUsImV4cCI6MjAzMzc1MDMwNX0.u52UJNzNT3jEhLQCVfzyeqxSCVwlYgdT538pqDB9Ap0";
        const url = "https://nbkplmfperjtegugcwzz.supabase.co";
        const database = supabase.createClient(url, key);

        document.addEventListener('DOMContentLoaded', async () => {
            loadDoctors();
            loadApprovedDoctors();

            document.getElementById('approveButton').addEventListener('click', async () => {
                const checkboxes = document.querySelectorAll('.doctor-checkbox:checked');
                const selectedDoctors = [];

                checkboxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const doctorId = row.dataset.d_id;
                    selectedDoctors.push(doctorId);
                });

                if (selectedDoctors.length === 0) {
                    alert('No doctors selected for approval.');
                    return;
                }

                try {
                    const { data, error } = await database
                        .from('doctors')
                        .update({ approve: true }) 
                        .in('d_id', selectedDoctors);

                    if (error) {
                        console.error('Error approving doctors:', error);
                        alert('Error approving doctors.');
                    } else {
                        alert('Selected doctors have been approved successfully.');
                        loadDoctors();
                        loadApprovedDoctors();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                }
            });

            function addDoctorToTable(doctor, tableBody, includeCheckbox) {
                const row = document.createElement('tr');
                row.dataset.d_id = doctor.d_id;
                row.innerHTML = `
                    <td class="py-2 px-8 border-b">${doctor.l_no}</td>
                    <td class="py-2 px-8 border-b">Dr.${doctor.firstname} ${doctor.lastname}</td>
                    <td class="py-2 px-8 border-b">${doctor.spec}</td>
                    <td class="py-2 px-8 border-b">${doctor.email}</td>
                    ${includeCheckbox ? '<td class="py-2 px-8 border-b"><input type="checkbox" class="doctor-checkbox"></td>' : ''}
                `;
                tableBody.appendChild(row);
            }

            async function loadDoctors() {
                try {
                    const { data: doctors, error } = await database
                        .from('doctors')
                        .select('d_id, l_no, firstname, lastname, spec, email')
                        .is('approve', false);

                    if (error) {
                        throw error;
                    }

                    const doctorTableBody = document.getElementById('doctorTableBody');
                    doctorTableBody.innerHTML = '';
                    doctors.forEach(doctor => {
                        addDoctorToTable(doctor, doctorTableBody, true);
                    });
                } catch (error) {
                    console.error('Error fetching doctors:', error.message);
                }
            }

            async function loadApprovedDoctors() {
                try {
                    const { data: approvedDoctors, error } = await database
                        .from('doctors')
                        .select('d_id, l_no, firstname, lastname, spec, email')
                        .eq('approve', true);

                    if (error) {
                        throw error;
                    }

                    const approvedDoctorTableBody = document.getElementById('approvedDoctorTableBody');
                    approvedDoctorTableBody.innerHTML = '';
                    approvedDoctors.forEach(doctor => {
                        addDoctorToTable(doctor, approvedDoctorTableBody, false);
                    });
                } catch (error) {
                    console.error('Error fetching approved doctors:', error.message);
                }
            }
        });

        // Navigation logic
        document.querySelectorAll('nav a').forEach(navLink => {
            navLink.addEventListener('click', function(event) {
                event.preventDefault();
                const targetId = this.getAttribute('data-target');
                document.querySelectorAll('section').forEach(section => {
                    if (section.id === targetId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>
